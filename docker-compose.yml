services:

    postgres:
      image: postgres
      container_name: wallet_app_db
      restart: on-failure
      env_file:
        - .env
      environment:
        - POSTGRES_USER=${DB_USER}
        - POSTGRES_PASSWORD=${DB_PASS}
        - POSTGRES_DB=${DB_NAME}
        - POSTGRES_PORT=${DB_PORT}
      volumes:
       - postgres_data:/var/lib/postgresql/data
  
    app:
      image: wallet_app
      container_name: wallet_app
      build:
        context: .
        dockerfile: Dockerfile
      restart: always
      env_file:
        - .env
      environment:
        - DATABASE_URL=postgresql://${DB_USER}:${DB_PASS}@postgres:${DB_PORT}/${DB_NAME}
      ports:
        - "8000:8000"
      command: uvicorn app.main:app --host 0.0.0.0 --port 8000
      depends_on:
        - postgres

    migrations:
      image: migrations
      container_name: migrations
      build:
        context: .
        dockerfile: Dockerfile
      command: alembic upgrade head
      depends_on:
        - postgres
      env_file:
        - .env
      environment:
        - DATABASE_URL=postgresql://${DB_USER}:${DB_PASS}@postgres:${DB_PORT}/${DB_NAME}
    dev:
      image: tests
      container_name: tests
      build:
        context: .
        dockerfile: Dockerfile
      environment:
        - DATABASE_URL=postgresql://${DB_USER}:${DB_PASS}@postgres:${DB_PORT}/${DB_TEST_NAME}
      command:  pytest app/tests
      depends_on:
        - postgres
        - migrations
volumes:
  postgres_data:
  